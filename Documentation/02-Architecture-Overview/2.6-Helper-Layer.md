# 2.6 لایه توابع کمکی (Helper Layer)

## 📋 فهرست مطالب
- [معرفی](#معرفی)
- [مسئولیت‌ها](#مسئولیتها)
- [Helper Classes](#helper-classes)
- [بهترین شیوه‌ها](#بهترین-شیوهها)

---

## معرفی

### 🎯 تعریف
لایه Helper شامل کلاس‌ها و توابع عمومی و کمکی است که در سراسر برنامه مورد استفاده قرار می‌گیرند و وابستگی به لایه‌های دیگر ندارند.

### 📁 مسیر
```
MainProject/Helpers/
MainProject/Config.cs
```

### 📊 آمار
- **تعداد Helper Classes**: ~3-4 کلاس
- **نوع**: Utility Classes, Static Methods

---

## مسئولیت‌ها

### ✅ مسئولیت‌های اصلی

#### 1. توابع عمومی (Common Functions)
- String Manipulation
- Date/Time Formatting
- Number Formatting
- Validation Helpers

#### 2. مدیریت تنظیمات (Configuration)
- خواندن App.config
- مدیریت Connection Strings
- مدیریت Settings

#### 3. اطلاعات کاربر (User Info)
- نگهداری اطلاعات کاربر جاری
- مدیریت Session
- Login Info

#### 4. Extension Methods
- توسعه Type های موجود
- متدهای کمکی

---

## Helper Classes

### 1️⃣ CommonFunctions

**مسئولیت**: توابع عمومی و پرکاربرد

```csharp
public static class CommonFunctions
{
    // 1. Validation Methods
    public static bool IsValidEmail(string email)
    {
        if (string.IsNullOrWhiteSpace(email))
            return false;
            
        try
        {
            var addr = new System.Net.Mail.MailAddress(email);
            return addr.Address == email;
        }
        catch
        {
            return false;
        }
    }
    
    public static bool IsValidPhoneNumber(string phone)
    {
        if (string.IsNullOrWhiteSpace(phone))
            return false;
            
        // حذف کاراکترهای غیرعددی
        string cleaned = new string(phone.Where(char.IsDigit).ToArray());
        
        return cleaned.Length >= 10 && cleaned.Length <= 11;
    }
    
    // 2. Formatting Methods
    public static string FormatCurrency(decimal amount)
    {
        return amount.ToString("N0") + " ریال";
    }
    
    public static string FormatDate(DateTime date)
    {
        // تبدیل به شمسی
        System.Globalization.PersianCalendar pc = 
            new System.Globalization.PersianCalendar();
        
        int year = pc.GetYear(date);
        int month = pc.GetMonth(date);
        int day = pc.GetDayOfMonth(date);
        
        return $"{year:0000}/{month:00}/{day:00}";
    }
    
    public static string FormatDateTime(DateTime dateTime)
    {
        return FormatDate(dateTime) + " " + dateTime.ToString("HH:mm:ss");
    }
    
    // 3. Conversion Methods
    public static DateTime? ToDateTime(string persianDate)
    {
        try
        {
            var parts = persianDate.Split('/');
            if (parts.Length != 3)
                return null;
                
            int year = int.Parse(parts[0]);
            int month = int.Parse(parts[1]);
            int day = int.Parse(parts[2]);
            
            System.Globalization.PersianCalendar pc = 
                new System.Globalization.PersianCalendar();
            
            return pc.ToDateTime(year, month, day, 0, 0, 0, 0);
        }
        catch
        {
            return null;
        }
    }
    
    public static decimal? ToDecimal(string value)
    {
        if (decimal.TryParse(value, out decimal result))
            return result;
        return null;
    }
    
    // 4. String Methods
    public static string ToPersianNumbers(string input)
    {
        if (string.IsNullOrEmpty(input))
            return input;
            
        string[] english = { "0", "1", "2", "3", "4", "5", "6", "7", "8", "9" };
        string[] persian = { "۰", "۱", "۲", "۳", "۴", "۵", "۶", "۷", "۸", "۹" };
        
        for (int i = 0; i < english.Length; i++)
        {
            input = input.Replace(english[i], persian[i]);
        }
        
        return input;
    }
    
    public static string ToEnglishNumbers(string input)
    {
        if (string.IsNullOrEmpty(input))
            return input;
            
        string[] persian = { "۰", "۱", "۲", "۳", "۴", "۵", "۶", "۷", "۸", "۹" };
        string[] english = { "0", "1", "2", "3", "4", "5", "6", "7", "8", "9" };
        
        for (int i = 0; i < persian.Length; i++)
        {
            input = input.Replace(persian[i], english[i]);
        }
        
        return input;
    }
    
    // 5. MessageBox Helpers
    public static void ShowSuccess(string message)
    {
        MessageBox.Show(message, "موفق", 
            MessageBoxButtons.OK, MessageBoxIcon.Information);
    }
    
    public static void ShowError(string message)
    {
        MessageBox.Show(message, "خطا", 
            MessageBoxButtons.OK, MessageBoxIcon.Error);
    }
    
    public static void ShowWarning(string message)
    {
        MessageBox.Show(message, "هشدار", 
            MessageBoxButtons.OK, MessageBoxIcon.Warning);
    }
    
    public static bool ShowConfirm(string message)
    {
        DialogResult result = MessageBox.Show(message, "تأیید", 
            MessageBoxButtons.YesNo, MessageBoxIcon.Question);
        
        return result == DialogResult.Yes;
    }
    
    // 6. DataGridView Helpers
    public static void SetupDataGridView(DataGridView dgv)
    {
        dgv.AutoGenerateColumns = true;
        dgv.SelectionMode = DataGridViewSelectionMode.FullRowSelect;
        dgv.MultiSelect = false;
        dgv.ReadOnly = true;
        dgv.AllowUserToAddRows = false;
        dgv.AllowUserToDeleteRows = false;
        dgv.RowHeadersVisible = false;
        dgv.BackgroundColor = Color.White;
        dgv.BorderStyle = BorderStyle.Fixed3D;
        
        // فونت فارسی
        dgv.Font = new Font("Tahoma", 9F);
        dgv.RightToLeft = RightToLeft.Yes;
    }
    
    public static void ExportToExcel(DataGridView dgv, string fileName)
    {
        // Export DataGridView to Excel
        // Implementation...
    }
}
```

---

### 2️⃣ LoginInfo

**مسئولیت**: نگهداری اطلاعات کاربر جاری (Singleton Pattern)

```csharp
public class LoginInfo
{
    // Singleton Instance
    private static LoginInfo _instance;
    private static readonly object _lock = new object();
    
    public static LoginInfo Instance
    {
        get
        {
            if (_instance == null)
            {
                lock (_lock)
                {
                    if (_instance == null)
                    {
                        _instance = new LoginInfo();
                    }
                }
            }
            return _instance;
        }
    }
    
    // Properties
    public int UserID { get; set; }
    public string Username { get; set; }
    public string FullName { get; set; }
    public string RoleName { get; set; }
    public int RoleID { get; set; }
    public DateTime LoginTime { get; set; }
    public bool IsLoggedIn { get; set; }
    
    // Permissions
    public bool CanAddItems { get; set; }
    public bool CanEditItems { get; set; }
    public bool CanDeleteItems { get; set; }
    public bool CanViewReports { get; set; }
    public bool IsAdmin { get; set; }
    
    // Private Constructor
    private LoginInfo()
    {
        IsLoggedIn = false;
    }
    
    // Methods
    public void Login(int userId, string username, string fullName, int roleId)
    {
        UserID = userId;
        Username = username;
        FullName = fullName;
        RoleID = roleId;
        LoginTime = DateTime.Now;
        IsLoggedIn = true;
        
        LoadPermissions();
    }
    
    public void Logout()
    {
        UserID = 0;
        Username = null;
        FullName = null;
        RoleID = 0;
        IsLoggedIn = false;
        
        ClearPermissions();
    }
    
    private void LoadPermissions()
    {
        // بارگذاری سطح دسترسی بر اساس RoleID
        switch (RoleID)
        {
            case 1: // Admin
                IsAdmin = true;
                CanAddItems = true;
                CanEditItems = true;
                CanDeleteItems = true;
                CanViewReports = true;
                break;
                
            case 2: // Manager
                IsAdmin = false;
                CanAddItems = true;
                CanEditItems = true;
                CanDeleteItems = false;
                CanViewReports = true;
                break;
                
            case 3: // User
                IsAdmin = false;
                CanAddItems = true;
                CanEditItems = false;
                CanDeleteItems = false;
                CanViewReports = false;
                break;
        }
    }
    
    private void ClearPermissions()
    {
        IsAdmin = false;
        CanAddItems = false;
        CanEditItems = false;
        CanDeleteItems = false;
        CanViewReports = false;
    }
    
    public bool HasPermission(string permissionName)
    {
        // بررسی دسترسی
        switch (permissionName.ToLower())
        {
            case "add":
                return CanAddItems;
            case "edit":
                return CanEditItems;
            case "delete":
                return CanDeleteItems;
            case "report":
                return CanViewReports;
            default:
                return false;
        }
    }
}
```

**استفاده:**
```csharp
// در زمان Login
LoginInfo.Instance.Login(userId, username, fullName, roleId);

// در سراسر برنامه
if (LoginInfo.Instance.IsLoggedIn)
{
    string userName = LoginInfo.Instance.FullName;
    bool canDelete = LoginInfo.Instance.CanDeleteItems;
}

// در زمان Logout
LoginInfo.Instance.Logout();
```

---

### 3️⃣ Config

**مسئولیت**: مدیریت تنظیمات برنامه

```csharp
public static class Config
{
    // Connection String
    public static string ConnectionString
    {
        get
        {
            return ConfigurationManager
                .ConnectionStrings["MainConnection"]
                .ConnectionString;
        }
    }
    
    // App Settings
    public static string GetSetting(string key)
    {
        return ConfigurationManager.AppSettings[key];
    }
    
    public static void SetSetting(string key, string value)
    {
        Configuration config = ConfigurationManager
            .OpenExeConfiguration(ConfigurationUserLevel.None);
        
        if (config.AppSettings.Settings[key] != null)
        {
            config.AppSettings.Settings[key].Value = value;
        }
        else
        {
            config.AppSettings.Settings.Add(key, value);
        }
        
        config.Save(ConfigurationSaveMode.Modified);
        ConfigurationManager.RefreshSection("appSettings");
    }
    
    // Default Values
    public static class Defaults
    {
        public static readonly int PageSize = 50;
        public static readonly string DateFormat = "yyyy/MM/dd";
        public static readonly string CurrencySymbol = "ریال";
        public static readonly decimal DefaultTaxRate = 0.09m;
        public static readonly int SessionTimeout = 30; // minutes
    }
    
    // Validation Rules
    public static class Validation
    {
        public static readonly int MinPasswordLength = 6;
        public static readonly int MaxNameLength = 100;
        public static readonly decimal MaxDiscount = 0.5m; // 50%
    }
}
```

**استفاده:**
```csharp
// دریافت Connection String
string connStr = Config.ConnectionString;

// دریافت تنظیمات
string companyName = Config.GetSetting("CompanyName");

// استفاده از مقادیر پیش‌فرض
int pageSize = Config.Defaults.PageSize;
decimal taxRate = Config.Defaults.DefaultTaxRate;
```

---

### 4️⃣ ExtensionMethods

**مسئولیت**: متدهای توسعه‌دهنده

```csharp
public static class StringExtensions
{
    public static bool IsNullOrEmpty(this string str)
    {
        return string.IsNullOrWhiteSpace(str);
    }
    
    public static string ToPersian(this string str)
    {
        return CommonFunctions.ToPersianNumbers(str);
    }
    
    public static string Truncate(this string str, int maxLength)
    {
        if (string.IsNullOrEmpty(str) || str.Length <= maxLength)
            return str;
            
        return str.Substring(0, maxLength) + "...";
    }
}

public static class DateTimeExtensions
{
    public static string ToPersianDate(this DateTime date)
    {
        return CommonFunctions.FormatDate(date);
    }
    
    public static string ToPersianDateTime(this DateTime dateTime)
    {
        return CommonFunctions.FormatDateTime(dateTime);
    }
}

public static class DecimalExtensions
{
    public static string ToCurrency(this decimal amount)
    {
        return CommonFunctions.FormatCurrency(amount);
    }
}
```

**استفاده:**
```csharp
string name = txtName.Text;
if (name.IsNullOrEmpty())
{
    // خالی است
}

DateTime now = DateTime.Now;
string persianDate = now.ToPersianDate();

decimal price = 1500000;
string formatted = price.ToCurrency(); // "1,500,000 ریال"
```

---

## بهترین شیوه‌ها

### ✅ DO (انجام دهید)

#### 1. Static Methods برای Utility Functions
```csharp
public static class Utils
{
    public static string FormatPhone(string phone)
    {
        // Implementation
    }
}
```

#### 2. Singleton برای State Management
```csharp
public class AppState
{
    private static AppState _instance;
    public static AppState Instance => _instance ?? (_instance = new AppState());
}
```

#### 3. Extension Methods برای توسعه Types
```csharp
public static class Extensions
{
    public static bool IsValid(this string email)
    {
        // Implementation
    }
}
```

---

### ❌ DON'T (انجام ندهید)

#### 1. منطق کسب‌وکار در Helper
```csharp
// ❌ اشتباه
public static decimal CalculateDiscount(decimal amount)
{
    // Business logic نباید اینجا باشد
}
```

#### 2. دسترسی به Database در Helper
```csharp
// ❌ اشتباه
public static List<Item> GetItems()
{
    // Database access نباید اینجا باشد
}
```

---

## 📅 تاریخچه تغییرات

### 2025-12-17
- ایجاد اولیه مستند Helper Layer
- توضیح Helper Classes
- Extension Methods

---

## Metadata (برای AI)

```json
{
  "document_type": "layer_documentation",
  "layer": "helper",
  "layer_name": "Helper Layer",
  "pattern": "Utility Classes",
  "language": "Persian (Farsi)",
  "classes_count": 4,
  "last_updated": "2025-12-17"
}
```
