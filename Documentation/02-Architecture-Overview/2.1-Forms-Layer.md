# 2.1 لایه رابط کاربری (Presentation Layer / Forms Layer)

## 📋 فهرست مطالب
- [معرفی](#معرفی)
- [مسئولیت‌ها](#مسئولیتها)
- [ساختار فرمها](#ساختار-فرمها)
- [دسته‌بندی فرمها](#دستهبندی-فرمها)
- [الگوهای رایج](#الگوهای-رایج)
- [بهترین شیوه‌ها](#بهترین-شیوهها)

---

## معرفی

### 🎯 تعریف
لایه Presentation یا Forms Layer اولین و مهم‌ترین نقطه تعامل کاربر با سیستم است. این لایه با استفاده از Windows Forms پیاده‌سازی شده و مسئول نمایش داده‌ها و دریافت ورودی از کاربر است.

### 📁 مسیر
```
MainProject/Forms/
```

### 📊 آمار
- **تعداد فرمها**: ~45 فرم
- **تعداد UserControls**: ~5 کنترل
- **تعداد Dialogs**: ~10 دیالوگ

---

## مسئولیت‌ها

### ✅ مسئولیت‌های اصلی

#### 1. نمایش داده‌ها (Display)
- نمایش لیست‌ها در DataGridView
- نمایش جزئیات در Controls
- نمایش گزارش‌ها
- نمایش داشبورد و خلاصه‌ها

#### 2. دریافت ورودی (Input)
- دریافت اطلاعات از TextBox, ComboBox, ...
- مدیریت رویدادها (Click, Change, ...)
- Validation ورودی (Client-side)
- مدیریت فرمت ورودی‌ها

#### 3. مدیریت جریان کار (Workflow)
- باز و بسته کردن فرمها
- انتقال بین فرمها
- مدیریت Modal Dialogs
- مدیریت منوها

#### 4. نمایش پیغام‌ها (Messages)
- پیغام‌های موفقیت
- پیغام‌های خطا
- تأییدیه‌ها (Confirmations)
- هشدارها (Warnings)

---

## ساختار فرمها

### 🏗️ ساختار استاندارد یک فرم

```csharp
public partial class ExampleFRM : Form
{
    // 1. Fields و Properties
    private ExampleManager _manager;
    private int _currentId;
    
    // 2. Constructor
    public ExampleFRM()
    {
        InitializeComponent();
        _manager = new ExampleManager();
    }
    
    // 3. Load Event
    private void ExampleFRM_Load(object sender, EventArgs e)
    {
        InitializeForm();
        LoadData();
    }
    
    // 4. Initialize Methods
    private void InitializeForm()
    {
        // تنظیمات اولیه
    }
    
    // 5. Load Data Methods
    private void LoadData()
    {
        // بارگذاری داده‌ها
    }
    
    // 6. Event Handlers
    private void btnSave_Click(object sender, EventArgs e)
    {
        // ذخیره داده
    }
    
    // 7. Validation Methods
    private bool ValidateInput()
    {
        // اعتبارسنجی
        return true;
    }
    
    // 8. Helper Methods
    private void ClearForm()
    {
        // پاکسازی فرم
    }
}
```

---

## دسته‌بندی فرمها

### 1️⃣ فرمهای تعریف پایه (Definition Forms)

**هدف**: تعریف اطلاعات پایه سیستم

**نمونه‌ها:**
- `DefineBasicItemsFRM` - تعریف اقلام پایه
- `DefineMenuItemsFRM` - تعریف منوی غذا
- `DefineSectionsFRM` - تعریف بخش‌ها
- `DefineUnitFRM` - تعریف واحدها
- `DefineJobsFRM` - تعریف مشاغل
- `DefineBankAccountFRM` - تعریف حساب بانکی

**ویژگی‌های مشترک:**
- CRUD Operations (Create, Read, Update, Delete)
- DataGridView برای نمایش لیست
- Panel برای ورود/ویرایش اطلاعات
- دکمه‌های استاندارد: جدید، ذخیره، ویرایش، حذف

**الگوی رایج:**
```
┌─────────────────────────────────┐
│  Title Bar                       │
├─────────────────────────────────┤
│  ┌─────────────────────────┐   │
│  │ Search & Filter Panel   │   │
│  └─────────────────────────┘   │
│  ┌─────────────────────────┐   │
│  │                         │   │
│  │    DataGridView         │   │
│  │    (List of Items)      │   │
│  │                         │   │
│  └─────────────────────────┘   │
│  ┌─────────────────────────┐   │
│  │ Input Panel             │   │
│  │ - TextBox               │   │
│  │ - ComboBox              │   │
│  │ - ...                   │   │
│  └─────────────────────────┘   │
│  [New] [Save] [Edit] [Delete]  │
└─────────────────────────────────┘
```

---

### 2️⃣ فرمهای عملیاتی (Operation Forms)

**هدف**: انجام عملیات اصلی سیستم

**نمونه‌ها:**
- `CreatSellFactorFRM` - ثبت فاکتور فروش
- `AccessLayerDeclarationFRM` - ثبت ورود/خروج انبار
- `DefineAndSubmitOverHead` - ثبت هزینه

**ویژگی‌های مشترک:**
- فرآیند چند مرحله‌ای
- محاسبات پیچیده
- تعامل با چندین جدول
- نیاز به Transaction Management

---

### 3️⃣ فرمهای گزارش (Report Forms)

**هدف**: نمایش گزارش‌ها و تحلیل‌ها

**نمونه‌ها:**
- فرمهای گزارش فروش
- فرمهای گزارش موجودی
- فرمهای گزارش مالی

**ویژگی‌های مشترک:**
- فیلترهای پیشرفته
- Export به Excel/PDF
- Print Preview
- Chart و نمودار

---

### 4️⃣ فرمهای مدیریتی (Management Forms)

**هدف**: مدیریت سیستم و کاربران

**نمونه‌ها:**
- `LoginFRM` - ورود به سیستم
- `MainFRM` - فرم اصلی
- `UserPanelFRM` - مدیریت کاربران

---

## الگوهای رایج

### 🎨 الگوی Master-Detail

```csharp
public partial class MasterDetailFRM : Form
{
    private void dgvMaster_SelectionChanged(object sender, EventArgs e)
    {
        if (dgvMaster.SelectedRows.Count > 0)
        {
            int masterId = (int)dgvMaster.SelectedRows[0].Cells["ID"].Value;
            LoadDetails(masterId);
        }
    }
    
    private void LoadDetails(int masterId)
    {
        var details = _manager.GetDetailsByMasterId(masterId);
        dgvDetail.DataSource = details;
    }
}
```

**استفاده در:**
- فرم فاکتور (Header + Items)
- فرم محصول (Product + Recipe)

---

### 🎨 الگوی CRUD استاندارد

```csharp
public partial class CrudFRM : Form
{
    private enum FormMode { View, New, Edit }
    private FormMode _currentMode = FormMode.View;
    
    private void btnNew_Click(object sender, EventArgs e)
    {
        _currentMode = FormMode.New;
        ClearForm();
        EnableInputs(true);
    }
    
    private void btnSave_Click(object sender, EventArgs e)
    {
        if (!ValidateInput()) return;
        
        var model = GetModelFromForm();
        
        if (_currentMode == FormMode.New)
        {
            _manager.Add(model);
        }
        else if (_currentMode == FormMode.Edit)
        {
            _manager.Update(model);
        }
        
        LoadData();
        _currentMode = FormMode.View;
    }
}
```

---

### 🎨 الگوی Search/Filter

```csharp
private void txtSearch_TextChanged(object sender, EventArgs e)
{
    string searchTerm = txtSearch.Text.Trim();
    FilterData(searchTerm);
}

private void FilterData(string searchTerm)
{
    if (string.IsNullOrEmpty(searchTerm))
    {
        dgvData.DataSource = _allData;
    }
    else
    {
        var filtered = _allData
            .Where(x => x.Name.Contains(searchTerm))
            .ToList();
        dgvData.DataSource = filtered;
    }
}
```

---

## بهترین شیوه‌ها

### ✅ DO (انجام دهید)

#### 1. Validation
```csharp
private bool ValidateInput()
{
    if (string.IsNullOrWhiteSpace(txtName.Text))
    {
        MessageBox.Show("نام الزامی است", "خطا", 
            MessageBoxButtons.OK, MessageBoxIcon.Warning);
        txtName.Focus();
        return false;
    }
    return true;
}
```

#### 2. Error Handling
```csharp
private void btnSave_Click(object sender, EventArgs e)
{
    try
    {
        if (!ValidateInput()) return;
        
        var result = _manager.Save(model);
        
        if (result)
        {
            MessageBox.Show("ذخیره با موفقیت انجام شد", "موفق",
                MessageBoxButtons.OK, MessageBoxIcon.Information);
        }
    }
    catch (Exception ex)
    {
        MessageBox.Show($"خطا: {ex.Message}", "خطا",
            MessageBoxButtons.OK, MessageBoxIcon.Error);
    }
}
```

#### 3. Resource Management
```csharp
protected override void OnFormClosing(FormClosingEventArgs e)
{
    base.OnFormClosing(e);
    
    // آزادسازی منابع
    if (_manager != null)
    {
        _manager.Dispose();
    }
}
```

---

### ❌ DON'T (انجام ندهید)

#### 1. منطق کسب‌وکار در Form
```csharp
// ❌ اشتباه - Business Logic در Form
private void btnCalculate_Click(object sender, EventArgs e)
{
    decimal price = decimal.Parse(txtPrice.Text);
    int quantity = int.Parse(txtQuantity.Text);
    decimal total = price * quantity;
    decimal discount = total * 0.1m; // Business Rule!
    txtTotal.Text = (total - discount).ToString();
}

// ✅ صحیح - فراخوانی Business Layer
private void btnCalculate_Click(object sender, EventArgs e)
{
    var result = _manager.CalculateTotal(price, quantity);
    txtTotal.Text = result.ToString();
}
```

#### 2. دسترسی مستقیم به Database
```csharp
// ❌ اشتباه - استفاده مستقیم از DAL
private void LoadData()
{
    var dal = new ItemDAL(); // نباید!
    dgvData.DataSource = dal.SelectAll();
}

// ✅ صحیح - از Manager استفاده کنید
private void LoadData()
{
    var items = _manager.GetAllItems();
    dgvData.DataSource = items;
}
```

---

## نکات مهم

### 🔒 امنیت
- اعتبارسنجی تمام ورودی‌ها
- جلوگیری از SQL Injection (با استفاده از Stored Procedures)
- مدیریت سطح دسترسی کاربران
- Disable کردن دکمه‌ها بر اساس نقش کاربر

### ⚡ Performance
- استفاده از Paging برای لیست‌های بزرگ
- Lazy Loading برای بارگذاری داده‌ها
- استفاده از Thread برای عملیات طولانی
- Cache کردن داده‌های استاتیک

### 🎨 UX/UI
- پیام‌های واضح و فارسی
- Tooltip برای راهنمایی کاربر
- Disable/Enable مناسب دکمه‌ها
- Tab Order صحیح
- Shortcut Keys

---

## 📅 تاریخچه تغییرات

### 2025-12-17
- ایجاد اولیه مستند لایه Forms
- توضیح دسته‌بندی فرمها
- الگوهای رایج

---

## Metadata (برای AI)

```json
{
  "document_type": "layer_documentation",
  "layer": "presentation",
  "layer_name": "Forms Layer",
  "technology": "Windows Forms",
  "language": "Persian (Farsi)",
  "forms_count": 45,
  "last_updated": "2025-12-17"
}
```
