# 2.5 لایه پایگاه داده (Database Layer)

## 📋 فهرست مطالب
- [معرفی](#معرفی)
- [مسئولیت‌ها](#مسئولیتها)
- [ساختار پایگاه داده](#ساختار-پایگاه-داده)
- [Stored Procedures](#stored-procedures)
- [بهترین شیوه‌ها](#بهترین-شیوهها)

---

## معرفی

### 🎯 تعریف
لایه Database شامل تمام اجزای پایگاه داده SQL Server است: جداول، Stored Procedures، Views، Functions و Triggers.

### 📁 مسیر
```
MainProject/DatabaseScripts/
MainProject/DataBaseScript.sql
```

### 📊 آمار
- **تعداد جداول**: ~25 جدول
- **تعداد Stored Procedures**: ~80 پروسیجر
- **DBMS**: Microsoft SQL Server 2016+

---

## مسئولیت‌ها

### ✅ مسئولیت‌های اصلی

#### 1. ذخیره‌سازی داده (Data Storage)
- ذخیره اطلاعات در جداول
- مدیریت Indexes
- مدیریت Constraints

#### 2. یکپارچگی داده (Data Integrity)
- Primary Keys
- Foreign Keys
- Check Constraints
- Unique Constraints

#### 3. منطق پایگاه داده (Database Logic)
- Stored Procedures
- Functions
- Views
- Triggers

#### 4. امنیت (Security)
- User Permissions
- Role-Based Access
- Data Encryption (optional)

---

## ساختار پایگاه داده

### 🗂️ گروه‌بندی جداول

#### 1. جداول اصلی (Master Tables)

**Tbl_Items** - اقلام پایه
```sql
CREATE TABLE Tbl_Items
(
    ItemID INT PRIMARY KEY IDENTITY(1,1),
    ItemName NVARCHAR(100) NOT NULL,
    UnitID INT FOREIGN KEY REFERENCES Tbl_Units(UnitID),
    UnitPrice DECIMAL(18,2),
    Quantity INT DEFAULT 0,
    MinQuantity INT DEFAULT 0,
    IsActive BIT DEFAULT 1,
    CreatedDate DATETIME DEFAULT GETDATE(),
    CreatedBy INT,
    ModifiedDate DATETIME,
    ModifiedBy INT
)
```

**Tbl_Products** - محصولات نهایی
```sql
CREATE TABLE Tbl_Products
(
    ProductID INT PRIMARY KEY IDENTITY(1,1),
    ProductName NVARCHAR(100) NOT NULL,
    SectionID INT FOREIGN KEY REFERENCES Tbl_Sections(SectionID),
    SalePrice DECIMAL(18,2) NOT NULL,
    CostPrice DECIMAL(18,2),
    Description NVARCHAR(500),
    IsAvailable BIT DEFAULT 1,
    CreatedDate DATETIME DEFAULT GETDATE()
)
```

**Tbl_Factors** - فاکتورهای فروش
```sql
CREATE TABLE Tbl_Factors
(
    FactorID INT PRIMARY KEY IDENTITY(1,1),
    FactorNumber NVARCHAR(20) UNIQUE NOT NULL,
    FactorDate DATETIME DEFAULT GETDATE(),
    CustomerID INT,
    TotalAmount DECIMAL(18,2),
    Discount DECIMAL(18,2) DEFAULT 0,
    FinalAmount DECIMAL(18,2),
    IsPaid BIT DEFAULT 0,
    PaymentDate DATETIME,
    CreatedBy INT,
    CreatedDate DATETIME DEFAULT GETDATE()
)
```

---

#### 2. جداول جزئیات (Detail Tables)

**Tbl_SubFactors** - آیتم‌های فاکتور
```sql
CREATE TABLE Tbl_SubFactors
(
    SubFactorID INT PRIMARY KEY IDENTITY(1,1),
    FactorID INT FOREIGN KEY REFERENCES Tbl_Factors(FactorID),
    ProductID INT FOREIGN KEY REFERENCES Tbl_Products(ProductID),
    Quantity INT NOT NULL,
    UnitPrice DECIMAL(18,2) NOT NULL,
    TotalPrice DECIMAL(18,2),
    Discount DECIMAL(18,2) DEFAULT 0
)
```

**Tbl_BasicRecipe** - دستور پخت محصولات
```sql
CREATE TABLE Tbl_BasicRecipe
(
    RecipeID INT PRIMARY KEY IDENTITY(1,1),
    ProductID INT FOREIGN KEY REFERENCES Tbl_Products(ProductID),
    ItemID INT FOREIGN KEY REFERENCES Tbl_Items(ItemID),
    Quantity DECIMAL(10,3) NOT NULL,
    UnitID INT FOREIGN KEY REFERENCES Tbl_Units(UnitID)
)
```

---

#### 3. جداول پایه (Lookup Tables)

**Tbl_Units** - واحدها
```sql
CREATE TABLE Tbl_Units
(
    UnitID INT PRIMARY KEY IDENTITY(1,1),
    UnitName NVARCHAR(50) NOT NULL,
    Symbol NVARCHAR(10),
    IsActive BIT DEFAULT 1
)
```

**Tbl_Sections** - بخش‌ها
```sql
CREATE TABLE Tbl_Sections
(
    SectionID INT PRIMARY KEY IDENTITY(1,1),
    SectionName NVARCHAR(100) NOT NULL,
    Description NVARCHAR(500),
    IsActive BIT DEFAULT 1
)
```

---

#### 4. جداول مالی (Financial Tables)

**Tbl_Accounts** - حساب‌های بانکی
```sql
CREATE TABLE Tbl_Accounts
(
    AccountID INT PRIMARY KEY IDENTITY(1,1),
    AccountNumber NVARCHAR(50) NOT NULL,
    AccountName NVARCHAR(100) NOT NULL,
    BankName NVARCHAR(100),
    Balance DECIMAL(18,2) DEFAULT 0,
    IsActive BIT DEFAULT 1,
    CreatedDate DATETIME DEFAULT GETDATE()
)
```

**Tbl_OverHeads** - هزینه‌ها
```sql
CREATE TABLE Tbl_OverHeads
(
    OverHeadID INT PRIMARY KEY IDENTITY(1,1),
    Title NVARCHAR(200) NOT NULL,
    Amount DECIMAL(18,2) NOT NULL,
    OverHeadDate DATETIME DEFAULT GETDATE(),
    CategoryID INT,
    AccountID INT FOREIGN KEY REFERENCES Tbl_Accounts(AccountID),
    Description NVARCHAR(500),
    CreatedDate DATETIME DEFAULT GETDATE()
)
```

---

#### 5. جداول کاربران (User Tables)

**Tbl_Users** - کاربران
```sql
CREATE TABLE Tbl_Users
(
    UserID INT PRIMARY KEY IDENTITY(1,1),
    Username NVARCHAR(50) UNIQUE NOT NULL,
    Password NVARCHAR(255) NOT NULL,
    FullName NVARCHAR(100),
    Email NVARCHAR(100),
    RoleID INT,
    IsActive BIT DEFAULT 1,
    LastLogin DATETIME,
    CreatedDate DATETIME DEFAULT GETDATE()
)
```

---

## Stored Procedures

### 📝 الگوی نام‌گذاری
```
SP_[TableName]_[Operation]
```

مثال:
- `SP_Items_SelectAll`
- `SP_Items_SelectByID`
- `SP_Items_Insert`
- `SP_Items_Update`
- `SP_Items_Delete`

---

### 🔍 SELECT Procedures

#### SP_Items_SelectAll
```sql
CREATE PROCEDURE SP_Items_SelectAll
AS
BEGIN
    SELECT 
        i.ItemID,
        i.ItemName,
        i.UnitID,
        u.UnitName,
        i.UnitPrice,
        i.Quantity,
        i.MinQuantity,
        i.IsActive,
        i.CreatedDate
    FROM Tbl_Items i
    LEFT JOIN Tbl_Units u ON i.UnitID = u.UnitID
    WHERE i.IsActive = 1
    ORDER BY i.ItemName
END
```

#### SP_Items_SelectByID
```sql
CREATE PROCEDURE SP_Items_SelectByID
    @ItemID INT
AS
BEGIN
    SELECT 
        ItemID,
        ItemName,
        UnitID,
        UnitPrice,
        Quantity,
        MinQuantity,
        IsActive,
        CreatedDate
    FROM Tbl_Items
    WHERE ItemID = @ItemID
END
```

---

### ➕ INSERT Procedures

```sql
CREATE PROCEDURE SP_Items_Insert
    @ItemName NVARCHAR(100),
    @UnitID INT,
    @UnitPrice DECIMAL(18,2),
    @Quantity INT,
    @MinQuantity INT,
    @CreatedBy INT
AS
BEGIN
    INSERT INTO Tbl_Items 
    (ItemName, UnitID, UnitPrice, Quantity, MinQuantity, CreatedBy, CreatedDate)
    VALUES 
    (@ItemName, @UnitID, @UnitPrice, @Quantity, @MinQuantity, @CreatedBy, GETDATE())
    
    SELECT SCOPE_IDENTITY() AS NewID
END
```

---

### ✏️ UPDATE Procedures

```sql
CREATE PROCEDURE SP_Items_Update
    @ItemID INT,
    @ItemName NVARCHAR(100),
    @UnitID INT,
    @UnitPrice DECIMAL(18,2),
    @Quantity INT,
    @MinQuantity INT,
    @ModifiedBy INT
AS
BEGIN
    UPDATE Tbl_Items
    SET 
        ItemName = @ItemName,
        UnitID = @UnitID,
        UnitPrice = @UnitPrice,
        Quantity = @Quantity,
        MinQuantity = @MinQuantity,
        ModifiedBy = @ModifiedBy,
        ModifiedDate = GETDATE()
    WHERE ItemID = @ItemID
END
```

---

### 🗑️ DELETE Procedures

```sql
CREATE PROCEDURE SP_Items_Delete
    @ItemID INT
AS
BEGIN
    -- Soft Delete
    UPDATE Tbl_Items
    SET IsActive = 0
    WHERE ItemID = @ItemID
    
    -- یا Hard Delete
    -- DELETE FROM Tbl_Items WHERE ItemID = @ItemID
END
```

---

### 📊 Complex Procedures

#### SP_Factor_CreateWithItems
```sql
CREATE PROCEDURE SP_Factor_CreateWithItems
    @FactorNumber NVARCHAR(20),
    @CustomerID INT,
    @TotalAmount DECIMAL(18,2),
    @Discount DECIMAL(18,2),
    @CreatedBy INT,
    @Items NVARCHAR(MAX) -- JSON format
AS
BEGIN
    BEGIN TRANSACTION
    
    BEGIN TRY
        -- 1. Insert Factor
        INSERT INTO Tbl_Factors 
        (FactorNumber, CustomerID, TotalAmount, Discount, FinalAmount, CreatedBy)
        VALUES 
        (@FactorNumber, @CustomerID, @TotalAmount, @Discount, 
         @TotalAmount - @Discount, @CreatedBy)
        
        DECLARE @FactorID INT = SCOPE_IDENTITY()
        
        -- 2. Insert SubFactors from JSON
        INSERT INTO Tbl_SubFactors (FactorID, ProductID, Quantity, UnitPrice, TotalPrice)
        SELECT 
            @FactorID,
            JSON_VALUE(value, '$.ProductID'),
            JSON_VALUE(value, '$.Quantity'),
            JSON_VALUE(value, '$.UnitPrice'),
            JSON_VALUE(value, '$.TotalPrice')
        FROM OPENJSON(@Items)
        
        -- 3. Update Inventory
        -- ... کسر موجودی
        
        COMMIT TRANSACTION
        
        SELECT @FactorID AS NewFactorID
    END TRY
    BEGIN CATCH
        ROLLBACK TRANSACTION
        THROW
    END CATCH
END
```

---

## Views

### 📋 Views for Reporting

```sql
CREATE VIEW VW_ProductsWithCost
AS
SELECT 
    p.ProductID,
    p.ProductName,
    p.SalePrice,
    SUM(r.Quantity * i.UnitPrice) AS CostPrice,
    p.SalePrice - SUM(r.Quantity * i.UnitPrice) AS Profit
FROM Tbl_Products p
LEFT JOIN Tbl_BasicRecipe r ON p.ProductID = r.ProductID
LEFT JOIN Tbl_Items i ON r.ItemID = i.ItemID
GROUP BY p.ProductID, p.ProductName, p.SalePrice
```

---

## Functions

### 🔧 Scalar Functions

```sql
CREATE FUNCTION FN_CalculateProductCost
(
    @ProductID INT
)
RETURNS DECIMAL(18,2)
AS
BEGIN
    DECLARE @Cost DECIMAL(18,2)
    
    SELECT @Cost = SUM(r.Quantity * i.UnitPrice)
    FROM Tbl_BasicRecipe r
    JOIN Tbl_Items i ON r.ItemID = i.ItemID
    WHERE r.ProductID = @ProductID
    
    RETURN ISNULL(@Cost, 0)
END
```

---

## Triggers

### ⚡ Audit Triggers

```sql
CREATE TRIGGER TR_Items_AuditLog
ON Tbl_Items
AFTER UPDATE, DELETE
AS
BEGIN
    INSERT INTO Tbl_AuditLog 
    (TableName, RecordID, Action, OldValue, NewValue, ChangedBy, ChangedDate)
    SELECT 
        'Tbl_Items',
        d.ItemID,
        CASE WHEN EXISTS(SELECT * FROM inserted) THEN 'UPDATE' ELSE 'DELETE' END,
        (SELECT * FROM deleted d WHERE d.ItemID = deleted.ItemID FOR JSON PATH),
        (SELECT * FROM inserted i WHERE i.ItemID = deleted.ItemID FOR JSON PATH),
        SYSTEM_USER,
        GETDATE()
    FROM deleted
END
```

---

## بهترین شیوه‌ها

### ✅ DO (انجام دهید)

#### 1. استفاده از Stored Procedures
- امنیت بیشتر
- Performance بهتر
- مدیریت آسان‌تر

#### 2. استفاده از Transactions
```sql
BEGIN TRANSACTION
-- عملیات‌ها
COMMIT TRANSACTION
```

#### 3. استفاده از Indexes
```sql
CREATE INDEX IX_Items_Name ON Tbl_Items(ItemName)
CREATE INDEX IX_Factors_Date ON Tbl_Factors(FactorDate)
```

#### 4. استفاده از Constraints
```sql
ALTER TABLE Tbl_Items
ADD CONSTRAINT CHK_Quantity CHECK (Quantity >= 0)

ALTER TABLE Tbl_Products
ADD CONSTRAINT CHK_Price CHECK (SalePrice > 0)
```

---

### ❌ DON'T (انجام ندهید)

#### 1. استفاده از SELECT *
```sql
-- ❌ اشتباه
SELECT * FROM Tbl_Items

-- ✅ صحیح
SELECT ItemID, ItemName, UnitPrice FROM Tbl_Items
```

#### 2. عدم استفاده از Parameters
```sql
-- ❌ خطرناک - SQL Injection
EXEC('SELECT * FROM Tbl_Items WHERE ItemName = ''' + @Name + '''')

-- ✅ ایمن
SELECT * FROM Tbl_Items WHERE ItemName = @Name
```

---

## 📅 تاریخچه تغییرات

### 2025-12-17
- ایجاد اولیه مستند Database Layer
- توضیح ساختار جداول
- الگوهای Stored Procedures

---

## Metadata (برای AI)

```json
{
  "document_type": "layer_documentation",
  "layer": "database",
  "layer_name": "Database Layer",
  "dbms": "SQL Server",
  "language": "Persian (Farsi)",
  "tables_count": 25,
  "procedures_count": 80,
  "last_updated": "2025-12-17"
}
```
