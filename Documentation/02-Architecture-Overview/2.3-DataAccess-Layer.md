# 2.3 لایه دسترسی به داده (Data Access Layer)

## 📋 فهرست مطالب
- [معرفی](#معرفی)
- [مسئولیت‌ها](#مسئولیتها)
- [ساختار DAL Classes](#ساختار-dal-classes)
- [الگوهای رایج](#الگوهای-رایج)
- [بهترین شیوه‌ها](#بهترین-شیوهها)

---

## معرفی

### 🎯 تعریف
لایه Data Access مسئول تمام ارتباطات با پایگاه داده است. این لایه با استفاده از ADO.NET و Stored Procedures پیاده‌سازی شده است.

### 📁 مسیر
```
MainProject/DataAccess/
```

### 📊 آمار
- **تعداد DAL Classes**: ~12 کلاس
- **الگوی نام‌گذاری**: `[Entity]DAL.cs`
- **فناوری**: ADO.NET

---

## مسئولیت‌ها

### ✅ مسئولیت‌های اصلی

#### 1. اجرای Query و Stored Procedure
- فراخوانی SP ها
- پاس دادن پارامترها
- دریافت نتایج

#### 2. مدیریت Connection
- باز و بسته کردن Connection
- مدیریت Connection Pool
- Timeout Management

#### 3. تبدیل داده
- ResultSet به Model
- Model به Parameters
- Type Conversion

#### 4. مدیریت خطا
- Catch کردن SQL Exceptions
- Log کردن خطاها
- پرتاب Exceptions مناسب

---

## ساختار DAL Classes

### 🏗️ ساختار استاندارد

```csharp
public class ExampleDAL
{
    // 1. Connection String
    private readonly string _connectionString;
    
    // 2. Constructor
    public ExampleDAL()
    {
        _connectionString = Config.ConnectionString;
    }
    
    // 3. Select All
    public List<ExampleModel> SelectAll()
    {
        List<ExampleModel> items = new List<ExampleModel>();
        
        using (SqlConnection conn = new SqlConnection(_connectionString))
        {
            using (SqlCommand cmd = new SqlCommand("SP_Example_SelectAll", conn))
            {
                cmd.CommandType = CommandType.StoredProcedure;
                
                conn.Open();
                
                using (SqlDataReader reader = cmd.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        items.Add(MapToModel(reader));
                    }
                }
            }
        }
        
        return items;
    }
    
    // 4. Select By ID
    public ExampleModel SelectByID(int id)
    {
        ExampleModel model = null;
        
        using (SqlConnection conn = new SqlConnection(_connectionString))
        {
            using (SqlCommand cmd = new SqlCommand("SP_Example_SelectByID", conn))
            {
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.AddWithValue("@ID", id);
                
                conn.Open();
                
                using (SqlDataReader reader = cmd.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        model = MapToModel(reader);
                    }
                }
            }
        }
        
        return model;
    }
    
    // 5. Insert
    public bool Insert(ExampleModel model)
    {
        using (SqlConnection conn = new SqlConnection(_connectionString))
        {
            using (SqlCommand cmd = new SqlCommand("SP_Example_Insert", conn))
            {
                cmd.CommandType = CommandType.StoredProcedure;
                
                AddParameters(cmd, model);
                
                conn.Open();
                int result = cmd.ExecuteNonQuery();
                
                return result > 0;
            }
        }
    }
    
    // 6. Update
    public bool Update(ExampleModel model)
    {
        using (SqlConnection conn = new SqlConnection(_connectionString))
        {
            using (SqlCommand cmd = new SqlCommand("SP_Example_Update", conn))
            {
                cmd.CommandType = CommandType.StoredProcedure;
                
                cmd.Parameters.AddWithValue("@ID", model.ID);
                AddParameters(cmd, model);
                
                conn.Open();
                int result = cmd.ExecuteNonQuery();
                
                return result > 0;
            }
        }
    }
    
    // 7. Delete
    public bool Delete(int id)
    {
        using (SqlConnection conn = new SqlConnection(_connectionString))
        {
            using (SqlCommand cmd = new SqlCommand("SP_Example_Delete", conn))
            {
                cmd.CommandType = CommandType.StoredProcedure;
                cmd.Parameters.AddWithValue("@ID", id);
                
                conn.Open();
                int result = cmd.ExecuteNonQuery();
                
                return result > 0;
            }
        }
    }
    
    // 8. Mapping Method
    private ExampleModel MapToModel(SqlDataReader reader)
    {
        return new ExampleModel
        {
            ID = reader.GetInt32(reader.GetOrdinal("ID")),
            Name = reader.GetString(reader.GetOrdinal("Name")),
            Price = reader.GetDecimal(reader.GetOrdinal("Price")),
            IsActive = reader.GetBoolean(reader.GetOrdinal("IsActive")),
            CreatedDate = reader.GetDateTime(reader.GetOrdinal("CreatedDate"))
        };
    }
    
    // 9. Add Parameters Helper
    private void AddParameters(SqlCommand cmd, ExampleModel model)
    {
        cmd.Parameters.AddWithValue("@Name", model.Name);
        cmd.Parameters.AddWithValue("@Price", model.Price);
        cmd.Parameters.AddWithValue("@IsActive", model.IsActive);
    }
}
```

---

## DAL Classes موجود

### 1. ItemDAL
**مسئولیت**: دسترسی به داده‌های اقلام پایه

**Stored Procedures**:
- `SP_Item_SelectAll`
- `SP_Item_SelectByID`
- `SP_Item_Insert`
- `SP_Item_Update`
- `SP_Item_Delete`

---

### 2. ProductDAL
**مسئولیت**: دسترسی به داده‌های محصولات

---

### 3. FactorDAL
**مسئولیت**: دسترسی به داده‌های فاکتور

---

### 4. AccountDAL
**مسئولیت**: دسترسی به داده‌های حساب بانکی

---

### 5. OverHeadDAL
**مسئولیت**: دسترسی به داده‌های هزینه‌ها

---

### 6. SellerDAL
**مسئولیت**: دسترسی به داده‌های فروشندگان

---

### 7. UnitDAL
**مسئولیت**: دسترسی به داده‌های واحدها

---

### 8. SectionDAL
**مسئولیت**: دسترسی به داده‌های بخش‌ها

---

### 9. LoginDAL
**مسئولیت**: احراز هویت کاربران

---

### 10. BasicItemDAL
**مسئولیت**: دسترسی به اقلام پایه گسترده

---

### 11. InformationDAL
**مسئولیت**: دسترسی به اطلاعات عمومی

---

### 12. UserPanelDAL
**مسئولیت**: دسترسی به داده‌های کاربران

---

## الگوهای رایج

### 🎨 الگوی Transaction

```csharp
public bool ExecuteWithTransaction(Action<SqlConnection, SqlTransaction> action)
{
    using (SqlConnection conn = new SqlConnection(_connectionString))
    {
        conn.Open();
        SqlTransaction transaction = conn.BeginTransaction();
        
        try
        {
            action(conn, transaction);
            transaction.Commit();
            return true;
        }
        catch
        {
            transaction.Rollback();
            throw;
        }
    }
}
```

---

### 🎨 الگوی Bulk Insert

```csharp
public bool BulkInsert(List<ExampleModel> items)
{
    DataTable dt = new DataTable();
    dt.Columns.Add("Name", typeof(string));
    dt.Columns.Add("Price", typeof(decimal));
    
    foreach (var item in items)
    {
        dt.Rows.Add(item.Name, item.Price);
    }
    
    using (SqlConnection conn = new SqlConnection(_connectionString))
    {
        conn.Open();
        using (SqlBulkCopy bulkCopy = new SqlBulkCopy(conn))
        {
            bulkCopy.DestinationTableName = "TempTable";
            bulkCopy.WriteToServer(dt);
        }
    }
    
    return true;
}
```

---

### 🎨 الگوی Safe Reader

```csharp
private T GetValue<T>(SqlDataReader reader, string columnName, T defaultValue = default(T))
{
    try
    {
        int ordinal = reader.GetOrdinal(columnName);
        
        if (reader.IsDBNull(ordinal))
            return defaultValue;
        
        return (T)reader.GetValue(ordinal);
    }
    catch
    {
        return defaultValue;
    }
}

// استفاده:
model.Name = GetValue<string>(reader, "Name", "");
model.Price = GetValue<decimal?>(reader, "Price", null);
```

---

## بهترین شیوه‌ها

### ✅ DO (انجام دهید)

#### 1. استفاده از Using
```csharp
using (SqlConnection conn = new SqlConnection(_connectionString))
{
    using (SqlCommand cmd = conn.CreateCommand())
    {
        // کد
    }
} // اتوماتیک Close و Dispose می‌شود
```

#### 2. استفاده از Stored Procedures
```csharp
// ✅ صحیح - استفاده از SP
cmd.CommandText = "SP_Example_Select";
cmd.CommandType = CommandType.StoredProcedure;
```

#### 3. استفاده از Parameters
```csharp
// ✅ صحیح - استفاده از Parameters
cmd.Parameters.AddWithValue("@ID", id);
cmd.Parameters.AddWithValue("@Name", name);
```

---

### ❌ DON'T (انجام ندهید)

#### 1. String Concatenation در Query
```csharp
// ❌ خطرناک - SQL Injection
string query = "SELECT * FROM Items WHERE Name = '" + name + "'";

// ✅ ایمن
cmd.CommandText = "SP_Item_SelectByName";
cmd.Parameters.AddWithValue("@Name", name);
```

#### 2. عدم بستن Connection
```csharp
// ❌ اشتباه
SqlConnection conn = new SqlConnection(_connectionString);
conn.Open();
// کدهای بدون using

// ✅ صحیح
using (SqlConnection conn = new SqlConnection(_connectionString))
{
    conn.Open();
    // کد
}
```

---

## نکات مهم

### 🔒 امنیت
- همیشه از Stored Procedures استفاده کنید
- هرگز Query را با String Concatenation نسازید
- از Parameters برای جلوگیری از SQL Injection

### ⚡ Performance
- استفاده از Connection Pooling
- Dispose کردن منابع با using
- استفاده از Async/Await برای عملیات I/O

### 🐛 Error Handling
- Catch کردن SqlException
- Log کردن خطاهای دیتابیس
- پرتاب Exceptions معنادار

---

## 📅 تاریخچه تغییرات

### 2025-12-17
- ایجاد اولیه مستند DAL Layer
- توضیح ساختار DAL Classes
- الگوهای رایج

---

## Metadata (برای AI)

```json
{
  "document_type": "layer_documentation",
  "layer": "data_access",
  "layer_name": "Data Access Layer",
  "technology": "ADO.NET",
  "pattern": "Repository Pattern",
  "language": "Persian (Farsi)",
  "dal_count": 12,
  "last_updated": "2025-12-17"
}
```
