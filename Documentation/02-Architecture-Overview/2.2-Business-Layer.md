# 2.2 لایه منطق کسب‌وکار (Business Logic Layer)

## 📋 فهرست مطالب
- [معرفی](#معرفی)
- [مسئولیت‌ها](#مسئولیتها)
- [ساختار Manager Classes](#ساختار-manager-classes)
- [الگوهای رایج](#الگوهای-رایج)
- [بهترین شیوه‌ها](#بهترین-شیوهها)

---

## معرفی

### 🎯 تعریف
لایه Business Logic قلب سیستم است و تمام منطق کسب‌وکار، قوانین، اعتبارسنجی‌ها و هماهنگی‌های بین لایه‌ها در اینجا پیاده‌سازی می‌شود.

### 📁 مسیر
```
MainProject/Core/Business/
```

### 📊 آمار
- **تعداد Manager Classes**: ~12 کلاس
- **الگوی نام‌گذاری**: `[Entity]Manager.cs`

---

## مسئولیت‌ها

### ✅ مسئولیت‌های اصلی

#### 1. پیاده‌سازی منطق کسب‌وکار
- قوانین محاسباتی (تخفیف، مالیات، ...)
- منطق تصمیم‌گیری
- فرآیندهای کسب‌وکار

#### 2. اعتبارسنجی (Validation)
- اعتبارسنجی Business Rules
- بررسی محدودیت‌ها
- تأیید صحت داده‌ها

#### 3. هماهنگی (Coordination)
- هماهنگی بین چند DAL
- مدیریت تراکنش‌ها
- اجرای عملیات ترکیبی

#### 4. تبدیل و پردازش
- تبدیل داده‌ها بین لایه‌ها
- پردازش و محاسبات
- Mapping بین Models

---

## ساختار Manager Classes

### 🏗️ ساختار استاندارد

```csharp
public class ExampleManager
{
    // 1. DAL Instance
    private readonly ExampleDAL _dal;
    
    // 2. Constructor
    public ExampleManager()
    {
        _dal = new ExampleDAL();
    }
    
    // 3. CRUD Methods
    public List<ExampleModel> GetAll()
    {
        try
        {
            var items = _dal.SelectAll();
            // Business logic processing
            return items;
        }
        catch (Exception ex)
        {
            // Log error
            throw new BusinessException("خطا در دریافت لیست", ex);
        }
    }
    
    public ExampleModel GetById(int id)
    {
        if (id <= 0)
            throw new ArgumentException("شناسه نامعتبر است");
            
        return _dal.SelectByID(id);
    }
    
    public bool Add(ExampleModel model)
    {
        // Validation
        ValidateModel(model);
        
        // Business Rules
        ApplyBusinessRules(model);
        
        // Insert
        return _dal.Insert(model);
    }
    
    public bool Update(ExampleModel model)
    {
        ValidateModel(model);
        CheckPermissions(model);
        return _dal.Update(model);
    }
    
    public bool Delete(int id)
    {
        CheckCanDelete(id);
        return _dal.Delete(id);
    }
    
    // 4. Validation Methods
    private void ValidateModel(ExampleModel model)
    {
        if (model == null)
            throw new ArgumentNullException(nameof(model));
            
        if (string.IsNullOrWhiteSpace(model.Name))
            throw new ValidationException("نام الزامی است");
            
        // More validations...
    }
    
    // 5. Business Rule Methods
    private void ApplyBusinessRules(ExampleModel model)
    {
        // Apply business logic
    }
    
    // 6. Helper Methods
    private bool CheckCanDelete(int id)
    {
        // Check dependencies
        return true;
    }
}
```

---

## Manager Classes موجود

### 1. ItemManager
**مسئولیت**: مدیریت اقلام پایه (Basic Items)

**متدهای اصلی**:
- `GetAllItems()`: دریافت لیست اقلام
- `GetItemById(int id)`: دریافت جزئیات یک قلم
- `AddItem(ItemModel model)`: افزودن قلم جدید
- `UpdateItem(ItemModel model)`: ویرایش قلم
- `DeleteItem(int id)`: حذف قلم

---

### 2. ProductManager
**مسئولیت**: مدیریت محصولات نهایی و دستور پخت

**متدهای اصلی**:
- `GetAllProducts()`: لیست محصولات
- `AddProduct(ProductModel model, List<RecipeModel> recipe)`: افزودن با دستور پخت
- `CalculateProductCost(int productId)`: محاسبه قیمت تمام شده

---

### 3. FactorManager
**مسئولیت**: مدیریت فاکتورهای فروش

**متدهای اصلی**:
- `CreateFactor(FactorModel factor, List<SubFactorModel> items)`: ثبت فاکتور
- `CalculateTotal(List<SubFactorModel> items)`: محاسبه جمع
- `ApplyDiscount(FactorModel factor)`: اعمال تخفیف

---

### 4. AccountManager
**مسئولیت**: مدیریت حساب‌های بانکی

---

### 5. OverHeadManager
**مسئولیت**: مدیریت هزینه‌ها

---

### 6. SellerManager
**مسئولیت**: مدیریت فروشندگان

---

### 7. UnitManager
**مسئولیت**: مدیریت واحدها

---

### 8. SectionManager
**مسئولیت**: مدیریت بخش‌ها

---

### 9. LoginManager
**مسئولیت**: مدیریت ورود و احراز هویت

**متدهای اصلی**:
- `Login(string username, string password)`: ورود کاربر
- `ValidateCredentials()`: اعتبارسنجی
- `GetUserPermissions(int userId)`: دریافت سطح دسترسی

---

### 10. UserPanelManager
**مسئولیت**: مدیریت کاربران

---

### 11. MainMenuManager
**مسئولیت**: مدیریت منوی اصلی

---

### 12. InformationsManager
**مسئولیت**: مدیریت اطلاعات عمومی

---

## الگوهای رایج

### 🎨 الگوی Transaction Management

```csharp
public bool CreateFactorWithItems(FactorModel factor, List<SubFactorModel> items)
{
    // شروع تراکنش
    using (var transaction = _dal.BeginTransaction())
    {
        try
        {
            // 1. ثبت فاکتور
            int factorId = _factorDAL.Insert(factor);
            
            // 2. ثبت آیتم‌ها
            foreach (var item in items)
            {
                item.FactorID = factorId;
                _subFactorDAL.Insert(item);
            }
            
            // 3. کسر موجودی
            UpdateInventory(items);
            
            // تأیید تراکنش
            transaction.Commit();
            return true;
        }
        catch
        {
            // برگشت تراکنش
            transaction.Rollback();
            throw;
        }
    }
}
```

---

### 🎨 الگوی Validation Chain

```csharp
public bool ValidateProduct(ProductModel product)
{
    var validators = new List<IValidator>
    {
        new RequiredFieldValidator(),
        new PriceRangeValidator(),
        new UniqueNameValidator()
    };
    
    foreach (var validator in validators)
    {
        if (!validator.Validate(product))
            return false;
    }
    
    return true;
}
```

---

### 🎨 الگوی Business Rule Engine

```csharp
public decimal CalculateDiscount(FactorModel factor)
{
    decimal discount = 0;
    
    // قانون 1: تخفیف بر اساس مبلغ
    if (factor.TotalAmount > 1000000)
        discount += factor.TotalAmount * 0.05m;
    
    // قانون 2: تخفیف بر اساس مشتری VIP
    if (factor.CustomerType == CustomerType.VIP)
        discount += factor.TotalAmount * 0.1m;
    
    // قانون 3: حداکثر تخفیف
    if (discount > factor.TotalAmount * 0.3m)
        discount = factor.TotalAmount * 0.3m;
    
    return discount;
}
```

---

## بهترین شیوه‌ها

### ✅ DO (انجام دهید)

#### 1. استفاده از Try-Catch
```csharp
public List<ItemModel> GetAllItems()
{
    try
    {
        return _dal.SelectAll();
    }
    catch (SqlException ex)
    {
        Logger.LogError("Database error", ex);
        throw new BusinessException("خطا در دریافت اطلاعات", ex);
    }
}
```

#### 2. Validation قبل از عملیات
```csharp
public bool AddItem(ItemModel item)
{
    // اعتبارسنجی
    if (!ValidateItem(item))
        return false;
    
    // بررسی تکراری نبودن
    if (IsItemNameDuplicate(item.Name))
        throw new DuplicateException("نام تکراری است");
    
    return _dal.Insert(item);
}
```

#### 3. استفاده از Custom Exceptions
```csharp
public class BusinessException : Exception
{
    public BusinessException(string message) : base(message) { }
    public BusinessException(string message, Exception inner) 
        : base(message, inner) { }
}
```

---

### ❌ DON'T (انجام ندهید)

#### 1. دسترسی مستقیم به Database
```csharp
// ❌ اشتباه
public void SaveItem(ItemModel item)
{
    string query = "INSERT INTO Items..."; // نباید!
    SqlCommand cmd = new SqlCommand(query);
}

// ✅ صحیح
public bool SaveItem(ItemModel item)
{
    return _dal.Insert(item);
}
```

#### 2. UI Logic در Business Layer
```csharp
// ❌ اشتباه
public void SaveItem(ItemModel item)
{
    _dal.Insert(item);
    MessageBox.Show("ذخیره شد"); // نباید!
}

// ✅ صحیح
public bool SaveItem(ItemModel item)
{
    return _dal.Insert(item);
    // Form مسئول نمایش پیغام است
}
```

---

## نکات مهم

### 🔒 امنیت
- اعتبارسنجی تمام ورودی‌ها
- بررسی سطح دسترسی کاربر
- جلوگیری از Business Logic Bypass

### ⚡ Performance
- Cache کردن داده‌های استاتیک
- استفاده از Async/Await برای عملیات طولانی
- Batch Processing برای عملیات گروهی

### 🧪 Testing
- Unit Test برای هر متد
- Test Coverage حداقل 80%
- Mock کردن DAL در تست‌ها

---

## 📅 تاریخچه تغییرات

### 2025-12-17
- ایجاد اولیه مستند Business Layer
- توضیح Manager Classes
- الگوهای رایج

---

## Metadata (برای AI)

```json
{
  "document_type": "layer_documentation",
  "layer": "business_logic",
  "layer_name": "Business Layer",
  "pattern": "Service Layer",
  "language": "Persian (Farsi)",
  "managers_count": 12,
  "last_updated": "2025-12-17"
}
```
